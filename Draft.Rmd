---
title: "Assignment 3 - Draft"
author: "Philipp Holz"
date: 'December 12, 2020'
output: 
  github_document:
    toc: true
    keep_html: true
bibliography: References.json

---

```{r libraries, include=FALSE}
# Loading the libraries ----
library(dplyr)
library(ggplot2)
library(scales)
library(lme4)
```


```{r data, eval=TRUE, include=FALSE}

# Data Wrangling -----
## Adding the Policy Data -----
### Read in the Data
policy_data <- read.csv("C:/Users/holzp/Desktop/RProject/PolicyData.csv")

### convert Date column to date format
policy_data$Date = as.Date(as.character(policy_data$Date), format = "%Y%m%d")

### create dataframe with only national level data
policy_data_countries <- policy_data %>% filter(Jurisdiction == "NAT_TOTAL")

### create dataframe with only national level of Germany, France, UK, Spain, Italy
policy_data_Europe <- policy_data_countries %>% filter(CountryCode == "DEU" |
                                                         CountryCode == "ITA" |
                                                         CountryCode == "FRA" |
                                                         CountryCode == "ESP" |
                                                         CountryCode == "GBR" |
                                                         CountryCode == "NLD" |
                                                         CountryCode == "BEL" |
                                                         CountryCode == "POL" |
                                                         CountryCode == "SWE" |
                                                         CountryCode == "AUT" |
                                                         CountryCode == "IRL" |
                                                         CountryCode == "DNK")


## Adding the Mobility Data ----
### Reading in the data
mobility_data <- read.csv("C:/Users/holzp/Desktop/RProject/MobilityData.csv")

### Add a column with an average of the change in sectors, excluding residential and parks

mobility_data <- mobility_data %>% mutate(avg_change = rowMeans(.[,c(6, 7, 9, 10)]))

### force recognition of the date format
mobility_data$date = as.Date(mobility_data$date, format = "%Y-%m-%d")

### Filter so that only country-level data remains
mobility_data_countries <- mobility_data %>% filter(sub.region.1 == "Total" & sub.region.2 == "Total")

### Create mobility data frame for Europe
mobility_data_Europe <- mobility_data_countries %>% filter(country == "Germany" |
                                                             country == "Italy" |
                                                             country == "France" |
                                                             country == "United Kingdom" |
                                                             country == "Spain" |
                                                             country == "Netherlands" |
                                                             country == "Belgium" |
                                                             country == "Poland" |
                                                             country == "Sweden" |
                                                             country == "Austria" |
                                                             country == "Denmark" |
                                                             country == "Ireland")

## Merging the Data into policyMobility_data_Europe ----
### renaming the date columns to match
names(mobility_data_Europe)[names(mobility_data_Europe)=="date"] <- "Date"
names(mobility_data_Europe)[names(mobility_data_Europe)=="country"] <- "CountryName"
names(mobility_data_Europe)[names(mobility_data_Europe)=="avg_change"] <- "MobilityIndex"

### Only selecting the columns that are interesting
mobility_data_Europe_small <- mobility_data_Europe %>% select(Date, CountryName, MobilityIndex)
policy_data_Europe_small <- policy_data_Europe %>% select(Date, CountryName, StringencyIndex)

### Merging policy and mobility data on date
policyMobility_data_Europe = mobility_data_Europe_small %>% 
  inner_join(policy_data_Europe_small, by = c("Date", "CountryName"))


## Adding a column with Compliance-index ----

policyMobility_data_Europe$ComplianceIndex <- 100 - (policyMobility_data_Europe$StringencyIndex + policyMobility_data_Europe$MobilityIndex)

### Rescaling the Compliance-index to assume values between 0 and 100

policyMobility_data_Europe$ComplianceIndex <- rescale(policyMobility_data_Europe$ComplianceIndex, to = c(0, 100))

```

# Introduction

The COVID-19-Pandemic is an ongoing challenge for policy-makers. Especially, because overcoming it is so dependent on the policy-compliance of each and every individual. However, how is the state of this policy-compliance in Europe? Does it differ across different countries and how does it evolve over time?

To find an answer to these questions, the following analysis will assess the following hypothesis.

H₀: There **is no** difference in compliance with mobility-reducing policies in Europe and this policy-compliance **does not** express a trend.

Hₐ: There **is** a difference in compliance with mobility-reducing policies in Europe and this policy-compliance **does** express a trend.

This analysis combines data from the Google COVID-19 Community Mobility Reports [@COVID19CommunityMobility2020] and data from the the Oxford Policy Tracker [@haleOxfordCOVID19Government2020]. The Google Mobility Report charts "movement trends over time by geography, across different categories."[@COVID19CommunityMobility2020] For the sake of this analysis the movement trends of the categories retail and recreation, supermarkets and pharmacies, public transport and workplaces were included and averaged without weighting. The Stringency Index was obtained from the Oxford Policy Tracker and records information on "the strictness of 'lockdown style' policies that primarily restrict people's behaviour."[@haleOxfordCOVID19Government2020]

Countries included in the analysis were chosen based on their membership to the EU (including the United Kingdom) and their GDP.

The following diagram shows how in March, April and May lock style policies were introduced and how mobility was reduced in concordance in almost all of the countries assessed. However, beginning immediately from there on, mobility started to increase again, with the gap between policy stringency and observed mobility-reduction widening. Note that policy stringency is on the left y-axis and mobility changes on the right. The scale of policy stringency is reversed for better comparability.

```{r faceted plot Stringency and Mobility, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a faceted plot with Stringency and Mobility for European Countries ----

ggplot(data = policyMobility_data_Europe) +
  geom_line(aes(x = Date, y = StringencyIndex), color = "black", linetype = "longdash", size = 0.5) +
  geom_smooth(aes(x = Date, y = -1*MobilityIndex), method = "loess", span = 1/10, 
              se = FALSE, size = 0.5, color = "black", linetype = "solid") +
  facet_wrap(~CountryName) +
  xlab("Month") +
  scale_x_date(breaks = date_breaks("3 months"),
               labels = date_format("%b\n%Y")) +
  scale_y_reverse(name = "Policy Stringency Index (dashed line)",
                  sec.axis = sec_axis(~.*-1, name = "Mobility %-change vs Baseline (solid line)")) +
  theme(
    axis.title.x = element_text(vjust = 0.5),
    axis.title.y = element_text(color = "black", size=12, vjust = 3),
    axis.title.y.right = element_text(color = "black", size=12, vjust = 3)
  ) +
  geom_hline(yintercept = 0, color = "black", size = 0.5) +
  ggtitle("Development of Policy Stringency and Mobility Reduction in Europe")
```


# Variation in Policy-Compliance

In order to build our model, we can make a preliminary, bivariate analysis that shows the variance of policy compliance across different European countries. 

For this step, we can approximate policy-compliance as the difference between the level of policy-stringency and the observed reduction in mobility. The boxplot shows us that, indeed, the levels of policy compliance among European countries differ.

```{r boxplot compliance, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a Boxplot of Compliance by Country ----
ggplot(data = policyMobility_data_Europe, aes(x = CountryName, y = ComplianceIndex)) +
  geom_boxplot() +
  xlab("Country") +
  ylab("Policy Compliance Index") +
  ggtitle("Policy Compliance in Europe") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
```

Additionally, as we want to assess the change of policy compliance across time in Europe, we can fit a linear regression line to the compliance data. This shows us that in all of the European countries analyzed, compliance with mobility-reducing-policies has reduced.

```{r facetted plot compliance, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a faceted plot with Compliance for European Countries ----
ggplot(policyMobility_data_Europe) +
  geom_smooth(aes(x = Date, y = ComplianceIndex), method = "loess", se = FALSE, span = 1/10, 
              color = "black", linetype = "solid", size = 0.1) +
  geom_smooth(aes(x = Date, y = ComplianceIndex), method = "lm", se = FALSE, 
              color = "black", linetype = "solid", size = 1) + 
  facet_wrap(~CountryName) +
  xlab("Month") +
  scale_x_date(breaks = date_breaks("3 months"),
               labels = date_format("%b\n%Y")) +
  scale_y_continuous(name = "Policy Compliance Index") +
  theme(
    axis.title.y = element_text(color = "black", size=12, vjust = 3),
    axis.title.x = element_text(size=12, vjust = 0.5)
    ) +
  ggtitle("Policy Compliance in Europe Across Time")
```

However, as initially stated, approximating policy-compliance as the difference between the level of policy-stringency and the observed reduction in mobility cannot be more than an approximation. When plotted across countries it shows a difference in means, and when plotted across time it shows a difference in trend.

An alternative measure of policy-compliance comes to mind, that accounts for measurement-errors and country-level differences. This alternative measure would be informed by the degree to which the mobility-reduction of a given population over time can be predicted by policy-stringency. As will be shown in more detail below, such a model is a hierarchical random-effect model.

# Modelling
## Linear Non-Hierachical Model

The following non-hierarchical model predicts the Mobility Index as the dependent variable, with the Stringency Index, Date and Country as the independent variables.

Predicted Mobility Index = β₀ + β₁ × Stringency Index + β₂ × Date + β₃ × Country + ε

It yields the following result. The continuous variables Stringency Index and Date are both statistically significant at the 0.05 level. They show that with increased stringency the mobility decreases, while a later date is associated with an increased mobility. Also all expressions of the categorical variable Country are significant at the 0.05 level, with the exception of the United Kingdom. 

The United Kingdom being a non-significant exception in the non-hierarchical linear model is an interesting case, as we could observe from our previous diagram with the compliance-approximation that, on a country-level with a random intercept and a random slope, the linear regression line fitted the United Kingdom data exceptionally *well*. Thus, we require 


| Variable                  | Coefficient | Std. Error | p-value      |
| ------------------------- | ----------- | ---------- | ------------ |
| Stringency Index          | -7.045e-01  | 9.107e-03  | < 2e-16 ***  |
| Date                      | 6.122e-02   | 1.993e-03  | < 2e-16 ***  |
| Belgium                   | 2.463e+00   | 8.466e-01  | 0.003649 **  |
| Denmark                   | 1.066e+01   | 8.430e-01  | < 2e-16 ***  |
| France                    | 5.306e+00   | 8.474e-01  | 4.25e-10 *** |
| Germany                   | 1.208e+01   | 8.445e-01  | < 2e-16 ***  |
| Ireland                   | 2.999e+00   | 8.523e-01  | 0.000439 *** |
| Italy                     | 5.026e+00   | 8.544e-01  | 4.39e-09 *** |
| Netherlands               | 5.089e+00   | 8.564e-01  | 3.09e-09 *** |
| Poland                    | 7.011e+00   | 8.443e-01  | < 2e-16 ***  |
| Spain                     | 2.109e+00   | 8.523e-01  | 0.013401 *   |
| Sweden                    | 1.117e+01   | 8.431e-01  | < 2e-16 ***  |
| United Kingdom            | -2.997e-01  | 8.499e-01  | 0.724393     |


# References


