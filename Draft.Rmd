---
title: "COVID-19 Policy-Compliance in Europe"
author: "Philipp Holz"
date: 'December 24, 2020'
output: 
  pdf_document:
    toc: true
    latex_engine: xelatex
bibliography: References.json

---

```{r libraries, include=FALSE}
# Loading the libraries ----
library(dplyr)
library(ggplot2)
library(scales)
library(lme4)
library(broom.mixed)
library(plotly)
library(reshape2)
library(utils)
library(texreg)
library(stargazer)
```


```{r data, eval=TRUE, include=FALSE}
# Data Wrangling -----
## Adding the Policy Data -----
### Read in the Data
policy_data <- read.csv("PolicyData.csv")

### convert Date column to date format
policy_data$Date = as.Date(as.character(policy_data$Date), format = "%Y%m%d")

### create dataframe with only national level data
policy_data_countries <- policy_data %>% filter(Jurisdiction == "NAT_TOTAL")

### create dataframe with only national level of Germany, France, UK, Spain, Italy
policy_data_Europe <- policy_data_countries %>% filter(CountryCode == "DEU" |
                                                         CountryCode == "ITA" |
                                                         CountryCode == "FRA" |
                                                         CountryCode == "ESP" |
                                                         CountryCode == "GBR" |
                                                         CountryCode == "NLD" |
                                                         CountryCode == "BEL" |
                                                         CountryCode == "POL" |
                                                         CountryCode == "SWE" |
                                                         CountryCode == "AUT" |
                                                         CountryCode == "IRL" |
                                                         CountryCode == "DNK")

### Only selecting the columns that are interesting
policy_data_Europe_small <- policy_data_Europe %>% select(Date, CountryName, StringencyIndex)


## Adding the Mobility Data ----
### Reading in the data
mobility_data <- read.csv("MobilityData.csv")

### Add a column with an average of the change in sectors, excluding residential and parks

mobility_data <- mobility_data %>% mutate(avg_change = rowMeans(.[,c(6, 7, 9, 10)]))

### force recognition of the date format
mobility_data$date = as.Date(mobility_data$date, format = "%Y-%m-%d")

### Filter so that only country-level data remains
mobility_data_countries <- mobility_data %>% filter(sub.region.1 == "Total" & sub.region.2 == "Total")

### Create mobility data frame for Europe
mobility_data_Europe <- mobility_data_countries %>% filter(country == "Germany" |
                                                             country == "Italy" |
                                                             country == "France" |
                                                             country == "United Kingdom" |
                                                             country == "Spain" |
                                                             country == "Netherlands" |
                                                             country == "Belgium" |
                                                             country == "Poland" |
                                                             country == "Sweden" |
                                                             country == "Austria" |
                                                             country == "Denmark" |
                                                             country == "Ireland")

### renaming the date columns to match
names(mobility_data_Europe)[names(mobility_data_Europe)=="date"] <- "Date"
names(mobility_data_Europe)[names(mobility_data_Europe)=="country"] <- "CountryName"
names(mobility_data_Europe)[names(mobility_data_Europe)=="avg_change"] <- "MobilityIndex"

### Only selecting relevant data
mobility_data_Europe_small <- mobility_data_Europe %>% select(Date, CountryName, MobilityIndex)


## Adding the Cases Data ----

###read the Dataset sheet in
cases_data <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv")

### renaming the date and countries columns to match
names(cases_data)[names(cases_data)=="dateRep"] <- "Date"
names(cases_data)[names(cases_data)=="countriesAndTerritories"] <- "CountryName"

### Forcing Date format
cases_data$Date = as.Date(as.character(cases_data$Date), format = "%d/%m/%Y")

### create dataframe with only national level of Germany, France, UK, Spain, Italy
cases_data_Europe <- cases_data %>% filter(CountryName == "Germany" |
                                             CountryName == "Italy" |
                                             CountryName == "France" |
                                             CountryName == "Spain" |
                                             CountryName == "United_Kingdom" |
                                             CountryName == "Netherlands" |
                                             CountryName == "Belgium" |
                                             CountryName == "Poland" |
                                             CountryName == "Sweden" |
                                             CountryName == "Ireland" |
                                             CountryName == "Austria" |
                                             CountryName == "Denmark")

### Changing United_Kingdom to United Kingdom
rename <- c(United_Kingdom="United Kingdom", Germany="Germany", Italy="Italy",
            France="France", Spain="Spain", Netherlands="Netherlands", Belgium="Belgium",
            Poland="Poland", Sweden="Sweden", Ireland="Ireland", Austria="Austria",
            Denmark="Denmark")

cases_data_Europe$CountryName <- as.character(rename[cases_data_Europe$CountryName])

### Only selecting the columns that are interesting
cases_data_Europe_small <- cases_data_Europe %>% select(Date, CountryName, notification_rate_per_100000_population_14.days)

## Adding the Trends Data ----
trends_data <- read.csv("GoogleTrends.csv", sep = ";")

### Forcing correct date format
trends_data$Date = as.Date(trends_data$Date, format = "%d.%m.%Y")+1

## Renaming the Sum column to Publicity
names(trends_data)[names(trends_data)=="Sum"] <- "Publicity"

## Only selecting the columns that are interesting
trends_data <- trends_data %>% select(Date, CountryName, Publicity)

## Merging policy mobility trends and cases data on date and country ----

data = policy_data_Europe_small %>% 
  full_join(mobility_data_Europe_small, by = c("Date", "CountryName")) %>%
  full_join(cases_data_Europe_small, by = c("Date", "CountryName")) %>%
  full_join(trends_data, by = c("Date", "CountryName"))

## Adding a column with Compliance-index ----

data$ComplianceIndex <- 100 - (data$StringencyIndex + data$MobilityIndex)

### Rescaling the Compliance-index to assume values between 0 and 100

data$ComplianceIndex <- rescale(data$ComplianceIndex, to = c(0, 100))


```

# Introduction

The COVID-19-Pandemic is an ongoing challenge for policy-makers. Especially, because overcoming it is so dependent on the policy-compliance of each and every individual. However, how is the state of this policy-compliance in Europe? Does it differ across different countries and how does it evolve over time?

To find an answer to these questions, the following analysis will assess the following hypothesis.

H(null): There **is no** difference in compliance with mobility-reducing policies in Europe and this policy-compliance **does not** express a trend.

H(alternative): There **is** a difference in compliance with mobility-reducing policies in Europe and this policy-compliance **does** express a trend.

This analysis combines data from the Google COVID-19 Community Mobility Reports [@COVID19CommunityMobility2020] and data from the the Oxford Policy Tracker [@haleOxfordCOVID19Government2020]. The Google Mobility Report charts "movement trends over time by geography, across different categories."[@COVID19CommunityMobility2020] For the sake of this analysis the movement trends of the categories retail and recreation, supermarkets and pharmacies, public transport and workplaces were included and averaged without weighting. The Stringency Index was obtained from the Oxford Policy Tracker and records information on "the strictness of 'lockdown style' policies that primarily restrict people's behaviour."[@haleOxfordCOVID19Government2020]

Countries included in the analysis were chosen based on their membership to the EU (including the United Kingdom) and their GDP.

The following diagram shows how in March, April and May lock style policies were introduced and how mobility was reduced in concordance in almost all of the countries assessed. However, beginning immediately from there on, mobility started to increase again, with the gap between policy stringency and observed mobility-reduction widening. Note that policy stringency is on the left y-axis and mobility changes on the right. The scale of policy stringency is reversed for better comparability.

```{r faceted plot Stringency and Mobility, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a faceted plot with Stringency and Mobility for European Countries ----

ggplot(data = data) +
  geom_line(aes(x = Date, y = StringencyIndex), color = "black", linetype = "longdash", size = 0.5) +
  geom_smooth(aes(x = Date, y = -1*MobilityIndex), method = "loess", span = 1/10, 
              se = FALSE, size = 0.5, color = "black", linetype = "solid") +
  facet_wrap(~CountryName) +
  xlab("Month") +
  scale_x_date(breaks = date_breaks("3 months"),
               labels = date_format("%b\n%Y")) +
  scale_y_reverse(name = "Policy Stringency Index (dashed line)",
                  sec.axis = sec_axis(~.*-1, name = "Mobility %-change vs Baseline (solid line)")) +
  theme(
    axis.title.x = element_text(vjust = 0.5),
    axis.title.y = element_text(color = "black", size=12, vjust = 3),
    axis.title.y.right = element_text(color = "black", size=12, vjust = 3)
  ) +
  geom_hline(yintercept = 0, color = "black", size = 0.5) +
  ggtitle("Development of Policy Stringency and Mobility Reduction in Europe")

```


# Variation in Policy-Compliance

In order to build our model, we can make a preliminary, bivariate analysis that shows the variance of policy compliance across different European countries. 

For this analysis, policy-compliance is approximated as the difference between the level of policy-stringency and the observed reduction in mobility. 

`Compliance = 100 - (Policy Stringency Index - %-change in Mobility)`

The boxplot shows us that, indeed, the levels of policy compliance among European countries differ.

```{r boxplot compliance, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a Boxplot of Compliance by Country ----
ggplot(data = data, aes(x = CountryName, y = ComplianceIndex)) +
  geom_boxplot() +
  xlab("Country") +
  ylab("Policy Compliance Index") +
  ggtitle("Policy Compliance in Europe") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
```

Additionally, as we want to assess the change of policy compliance across time in Europe, we can fit a linear regression line to the compliance data. This shows us that in all of the European countries analyzed, compliance with mobility-reducing-policies has reduced.

```{r facetted plot compliance, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
## Create a faceted plot with Compliance for European Countries ----
ggplot(data) +
  geom_smooth(aes(x = Date, y = ComplianceIndex), method = "loess", se = FALSE, span = 1/10, 
              color = "black", linetype = "solid", size = 0.1) +
  geom_smooth(aes(x = Date, y = ComplianceIndex), method = "lm", se = FALSE, 
              color = "black", linetype = "solid", size = 1) + 
  facet_wrap(~CountryName) +
  xlab("Month") +
  scale_x_date(breaks = date_breaks("3 months"),
               labels = date_format("%b\n%Y")) +
  scale_y_continuous(name = "Policy Compliance Index") +
  theme(
    axis.title.y = element_text(color = "black", size=12, vjust = 3),
    axis.title.x = element_text(size=12, vjust = 0.5)
    ) +
  ggtitle("Policy Compliance in Europe Across Time")
```

# Modelling
## Linear Non-Hierachical Model

The following non-hierarchical model predicts the Mobility Index as the dependent variable, with the Stringency Index, Date and Country as the independent variables.

\begin{equation}
{Compliance Index} = {\beta}_0 + {\beta}_1 * {Date} + {\beta}_2 * {Country} + {\beta}_3 * {Publicity} + {\beta}_4 * {Cases/100.000/14 days} + {\epsilon}
\end{equation}

It yields the following result. Except for Date, non of the continuous variables Publicity and Cases/100.000/14 Days are statistically significant. Date is statistically significant at the 0.05 level. It's coefficient shows that when holding Publicity, Cases and Country constant, Compliance decreases by 0.07 points each day.

With Country as the categorical variable, all expressions are statistically significant at the 0.05 level, with the exception of Belgium, Ireland, the Netherlands and the United Kingdom, when compared to Austria as the reference category. The adjusted R² indicates that the model explains 29% of the observed variance.

```{r Regression Table, echo=FALSE, fig.align='center', results="asis"}

# Fit the model
lm1 <- lm(data = data, ComplianceIndex ~ Date + Publicity + notification_rate_per_100000_population_14.days + CountryName)

# Generate regression table
texreg::texreg(lm1, single.row = TRUE, 
#                         custom.header = list("Model Results" = 1),
#                         model.names = c("My name 1", "My name 2"), 
                         custom.coef.names = c("Intercept", "Date", "Publicity",
                                               "Cases/100,000/14 Days",
                                               "Belgium",
                                               "Denmark",
                                               "France",
                                               "Germany",
                                               "Ireland",
                                               "Italy",
                                               "Netherlands",
                                               "Poland",
                                               "Spain",
                                               "Sweden",
                                               "United Kingdom"),
                          bold = 0.05,
                          center = TRUE,
                          caption = "Regression Table"
                         )
```

## Linear Multi-Level Model

However, when plotting the fitted values from the non-hierarchical linear model by country, we can observe different discrete levels of compliance by date, e.g. with Austria showing much higher levels of compliance than Germany and Sweden.

```{r Linear model predictions by country, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
### Visualising different predicted intercepts and different slopes
ggplot(data = augment(lm(data = data, 
                         ComplianceIndex ~ Date + CountryName + Publicity + notification_rate_per_100000_population_14.days)),
       aes(x = Date, y = ComplianceIndex, color = CountryName))  +
  geom_smooth(aes(y = .fitted), method = "lm", se = FALSE) +
  xlab("Month") +
  scale_x_date(breaks = date_breaks("3 months"),
               labels = date_format("%b\n%Y")) +
  scale_y_continuous(name = "Policy Compliance Index") +
  theme(
    axis.title.y = element_text(color = "black", size=12, vjust = 3),
    axis.title.x = element_text(size=12, vjust = 0.5)
    ) +
  ggtitle("Model Predictions for Policy Compliance in Europe Across Time")
```

This suggests creating a hierarchical model with a random intercept for country in order to improve model fit.

# References


